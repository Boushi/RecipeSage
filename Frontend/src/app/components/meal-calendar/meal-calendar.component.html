<div class="mealplan-flex">
  <div>
    <div class="calendar-nav">
      <ion-button
        class="previous"
        fill="clear"
        (click)="moveCalendar(-1)">
        <ion-icon name="caret-back" slot="icon-only"></ion-icon>
      </ion-button>
      <span>{{ calendarTitle() }}</span>
      <ion-button
        class="next"
        fill="clear"
        (click)="moveCalendar(1)">
        <ion-icon name="caret-forward" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <ion-grid class="calendar" [ngClass]="{ full: mode === 'full', split: mode === 'split', outline: mode === 'outline' }">
      <ion-row class="week-title">
        <ion-col class="day-title" *ngFor="let day of dayTitles">
          {{day}}
        </ion-col>
      </ion-row>
      <ion-row class="week" *ngFor="let weekOfMonth of weeksOfMonth">
        <ion-col
          class="day"
          *ngFor="let day of weekOfMonth"
          (click)="selectedDay = day"
          (keyup.enter)="selectedDay = day"
          (dragover)="dragOver($event, day)"
          (drop)="dragDrop($event, day)"
          [ngClass]="{
              'selected': selectedDay && selectedDay.year() === day.year() && selectedDay.month() === day.month() && selectedDay.date() === day.date(),
              'today'   : today.getFullYear() === day.year() && today.getMonth() === day.month() && today.getDate() === day.date()
            }" tabindex="0">
          <div class="date" [ngClass]="{
            'selected': selectedDay && selectedDay.year() === day.year() && selectedDay.month() === day.month() && selectedDay.date() === day.date(),
            'inactive': center.getMonth() !== day.month(),
            'today'   : today.getFullYear() === day.year() && today.getMonth() === day.month() && today.getDate() === day.date()
          }">
            {{day.date()}}
          </div>
          <div *ngIf="mode === 'full'">
            <div class="meal-group" *ngFor="let mealName of mealItemsByDay(day).meals">
              <span class="meal-title" *ngIf="mealItemsByDay(day).itemsByMeal[mealName].length > 0">{{ mealName }}</span>
              <calendar-item
                *ngFor="let mealItem of mealItemsByDay(day).itemsByMeal[mealName]"
                [mealItem]="mealItem"
                (click)="itemClicked.emit(mealItem)"
                draggable="{{ enableEditing }}"
                (dragstart)="dragStart($event, mealItem)"
                (dragend)="dragEnd($event, mealItem)"
                [ngClass]="{
                  'dragging': mealItem.dragging,
                  'breakfast': mealItem.meal === 'breakfast',
                  'lunch': mealItem.meal === 'lunch',
                  'dinner': mealItem.meal === 'dinner',
                  'snacks': mealItem.meal === 'snacks',
                  'other': mealItem.meal === 'other'
                }"
              ></calendar-item>
            </div>
          </div>
          <div class="meal-marker-container" *ngIf="mode === 'split' || mode === 'outline'">
            <div class="meal-marker" *ngFor="let mealItem of mealItemsByDay(day).items"></div>
          </div>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>
  <ion-list *ngIf="mode === 'split'" class="meal-list" lines="none" class="ion-padding">
    <ion-item lines="none">
      <ion-label class="ion-text-center ion-no-padding">
        Meals & Items:
      </ion-label>
    </ion-item>

    <ion-item *ngIf="mealItemsByDay(this.selectedDay).items.length === 0 && initialLoadComplete">
      <ion-label class="ion-text-wrap ion-text-center">
        <br />
        <br />
        <br />
        <p>
          There are no meals scheduled for this day.
          <br />
          <ion-button (click)="newMealPlanItem()">
            <ion-icon name="add" slot="start"></ion-icon>
            <ion-label>
              Add a meal
            </ion-label>
          </ion-button>
        </p>
      </ion-label>
    </ion-item>

    <div *ngFor="let mealItem of mealItemsByDay(this.selectedDay).items; let idx = index;">
      <ion-item-divider class="mealTitle" *ngIf="idx === 0 || mealItemsByDay(this.selectedDay).items[idx - 1].meal !== mealItem.meal">
        {{mealItem.meal}}
      </ion-item-divider>
      <ion-item (click)="mealItem.recipe && openRecipe(mealItem.recipe)" class="ion-text-wrap" [ngClass]="{ 'cursor-pointer': mealItem.recipe }">
        <ion-label class="ion-text-wrap">
          {{mealItem.title}}

          <p *ngIf="preferences[preferenceKeys.ShowAddedOn]">
            Added
            <span>{{ formatItemCreationDate(mealItem.createdAt) }}</span>
          </p>
          <p *ngIf="preferences[preferenceKeys.ShowAddedBy] && mealPlan.collaborators.length > 0 && mealItem.owner">
            <span *ngIf="!preferences[preferenceKeys.ShowAddedOn]">Added </span>by
            <span>{{ mealItem.owner.name || mealItem.owner.email }}</span>
          </p>
        </ion-label>

        <!-- Remove from cart button: -->
        <ion-button
          slot="end"
          fill="none"
          class="ion-margin-start"
          *ngIf="mealItem.recipe && mealItem.shoppingListItems.length > 0"
          (click)="$event.stopPropagation(); removeMealPlanItemFromShoppingList(mealItem)">
          <ion-icon name="cart" slot="icon-only"></ion-icon>
        </ion-button>
        <!-- Add to cart button: -->
        <ion-button
          slot="end"
          fill="none"
          class="ion-margin-start"
          *ngIf="mealItem.recipe && mealItem.shoppingListItems.length === 0"
          (click)="$event.stopPropagation(); addMealPlanItemToShoppingList(mealItem)">
          <ion-icon name="cart" slot="icon-only"></ion-icon>
        </ion-button>
        <!-- Remove from meal plan button: -->
        <ion-button
          slot="end"
          fill="none"
          class="ion-margin-start"
          (click)="$event.stopPropagation(); removeItem(mealItem)">
          <ion-icon name="trash" slot="icon-only"></ion-icon>
        </ion-button>
      </ion-item>
    </div>
  </ion-list>
</div>

